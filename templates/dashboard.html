<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文件管理系統 - 文件管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <style>
    /* 確保深色模式下的按鈕和文字高對比 */
    [data-theme="dark"] .bg-white { background-color: #1f2937; }
    [data-theme="dark"] .text-black { color: #e5e7eb; }
    [data-theme="dark"] .border-gray-200 { border-color: #4b5563; }
    [data-theme="dark"] .text-gray-600 { color: #9ca3af; }
    [data-theme="dark"] .text-gray-500 { color: #6b7280; }
  </style>
</head>
<body class="min-h-screen" id="body" data-theme="light">
  <nav class="bg-blue-600 p-4 shadow-md sticky top-0 z-10">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
      <h1 class="text-white text-xl font-bold">文件管理系統</h1>
      <div class="flex items-center space-x-4">
        <span id="username" class="text-white text-sm hidden sm:block">載入中...</span>
        <a href="/dashboard" class="text-white hover:underline transition duration-200">文件管理</a>
        <a href="/settings" class="text-white hover:underline transition duration-200">個人化設置</a>
        <a href="/logout" class="text-white hover:underline transition duration-200">登出</a>
      </div>
    </div>
  </nav>

  <div class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-6">文件管理</h2>

    <div class="mb-6 space-y-4">
      <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data" class="flex flex-col sm:flex-row gap-4">
        <input type="file" name="file" id="fileInput" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">上傳</button>
      </form>

      <input type="text" id="searchInput" placeholder="搜尋文件名稱..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
      <div class="flex flex-col sm:flex-row gap-4">
        <input type="text" id="aiSearchInput" placeholder="AI 搜尋文件內容..." class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
        <button onclick="aiSearch()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">AI 搜尋</button>
      </div>
    </div>

    <div id="fileList" class="grid gap-4"></div>

    <div class="mt-8">
      <h3 class="text-xl font-bold mb-4">推薦文件</h3>
      <div id="recommendations" class="grid gap-4"></div>
    </div>
  </div>

  <script>
    // 初始化 toastr 設置
    toastr.options = {
      closeButton: true,
      progressBar: true,
      timeOut: 5000,
      positionClass: 'toast-top-right'
    };

    // 獲取用戶資訊
    async function fetchUserInfo() {
      try {
        const response = await fetch('/user_info');
        if (!response.ok) {
          if (response.status === 401) {
            console.warn('Unauthorized access, redirecting to login');
            toastr.error('請先登入');
            window.location.href = '/login';
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const data = await response.json();
        console.log('fetchUserInfo response:', data);
        if (data.error) {
          toastr.error(data.error);
          if (data.error === '未登入') {
            window.location.href = '/login';
          }
          return;
        }
        if (data.username) {
          document.getElementById('username').innerText = `歡迎，${data.username}`;
        } else {
          document.getElementById('username').innerText = '未知用戶';
          console.warn('No username in response:', data);
        }
      } catch (error) {
        console.error('fetchUserInfo error:', error);
        toastr.error('載入用戶資訊失敗');
        window.location.href = '/login';
      }
    }

    // 主題切換邏輯
    function renderFiles(files, theme) {
      const body = document.getElementById('body');
      body.className = 'min-h-screen ' + (theme === 'dark' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-black');
      body.dataset.theme = theme;
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';

      if (files.length === 0) {
        fileList.innerHTML = '<p class="text-sm text-gray-500">無搜尋結果</p>';
        return;
      }

      files.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'border border-gray-200 p-4 rounded flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
        fileDiv.innerHTML = `
          <div>
            <h3 class="font-bold text-lg">${file.name}</h3>
            <p class="text-sm text-gray-600">擁有者: ${file.owner}</p>
            <p class="text-sm text-gray-600">共享給: ${file.shared_with.join(', ') || '無'}</p>
            ${file.similarity ? `<p class="text-sm text-gray-600">相似度: ${(file.similarity * 100).toFixed(2)}%</p>` : ''}
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="openShare(${file.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition duration-200" ${file.owner_id !== file.current_user_id ? 'disabled' : ''}>共享</button>
            <button onclick="deleteFile(${file.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition duration-200" ${file.owner_id !== file.current_user_id ? 'disabled' : ''}>刪除</button>
            <a href="/download/${file.id}" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition duration-200">下載</a>
          </div>
          <div id="share-${file.id}" class="mt-2 hidden w-full">
            <div class="flex gap-2">
              <input type="text" id="shareUsername-${file.id}" placeholder="輸入用戶名進行共享" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
              <button onclick="shareFile(${file.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition duration-200">確認共享</button>
            </div>
          </div>
        `;
        fileList.appendChild(fileDiv);
      });
    }

    // 渲染推薦文件
    function renderRecommendations(files, theme) {
      document.getElementById('body').dataset.theme = theme;
      const recList = document.getElementById('recommendations');
      recList.innerHTML = '';

      if (files.length === 0) {
        recList.innerHTML = '<p class="text-sm text-gray-500">暫無推薦文件</p>';
        return;
      }

      files.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'border border-gray-200 p-4 rounded flex justify-between items-center';
        fileDiv.innerHTML = `
          <div>
            <h3 class="font-bold">${file.name}</h3>
            <p class="text-sm text-gray-600">相似度: ${(file.similarity * 100).toFixed(2)}%</p>
          </div>
          <a href="/download/${file.id}" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition duration-200">下載</a>
        `;
        recList.appendChild(fileDiv);
      });
    }

    // 打開共享表單
    function openShare(fileId) {
      document.getElementById(`share-${fileId}`).classList.toggle('hidden');
    }

    // 共享文件
    async function shareFile(fileId) {
      const username = document.getElementById(`shareUsername-${fileId}`).value;
      try {
        const response = await fetch('/share', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: fileId, username })
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const result = await response.json();
        if (result.error) {
          toastr.error(result.error);
          if (result.error === '未登入') {
            window.location.href = '/login';
          }
        } else {
          toastr.success('文件共享成功');
          fetchFiles();
        }
      } catch (error) {
        console.error('shareFile error:', error);
        toastr.error('共享文件失敗');
        window.location.href = '/login';
      }
    }

    // 刪除文件
    async function deleteFile(fileId) {
      try {
        const response = await fetch('/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: fileId })
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const result = await response.json();
        if (result.error) {
          toastr.error(result.error);
          if (result.error === '未登入') {
            window.location.href = '/login';
          }
        } else {
          toastr.success('文件刪除成功');
          fetchFiles();
        }
      } catch (error) {
        console.error('deleteFile error:', error);
        toastr.error('刪除文件失敗');
        window.location.href = '/login';
      }
    }

    // 獲取文件列表
    async function fetchFiles(searchQuery = '') {
      try {
        const response = await fetch(`/files?search=${searchQuery}`);
        if (!response.ok) {
          if (response.status === 401) {
            toastr.error('請先登入');
            window.location.href = '/login';
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const data = await response.json();
        if (data.error) {
          toastr.error(data.error);
          if (data.error === '未登入') {
            window.location.href = '/login';
          }
        } else {
          renderFiles(data.files, data.theme);
        }
      } catch (error) {
        console.error('fetchFiles error:', error);
        toastr.error('載入文件列表失敗');
        window.location.href = '/login';
      }
    }

    // AI 搜尋
    async function aiSearch() {
      const query = document.getElementById('aiSearchInput').value;
      if (!query) {
        toastr.warning('請輸入搜尋內容');
        return;
      }
      try {
        const response = await fetch('/ai_search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const result = await response.json();
        console.log('AI Search Response:', result);
        if (result.error) {
          toastr.error(result.error);
          if (result.error === '未登入') {
            window.location.href = '/login';
          }
        } else {
          renderFiles(result.files, result.theme);
        }
      } catch (error) {
        console.error('aiSearch error:', error);
        toastr.error('AI 搜尋失敗');
        window.location.href = '/login';
      }
    }

    // 獲取推薦文件
    async function fetchRecommendations() {
      try {
        const response = await fetch('/recommend');
        if (!response.ok) {
          if (response.status === 401) {
            toastr.error('請先登入');
            window.location.href = '/login';
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          toastr.error('伺服器響應異常');
          window.location.href = '/login';
          return;
        }
        const result = await response.json();
        console.log('Recommendations Response:', result);
        if (result.error) {
          toastr.error(result.error);
          if (result.error === '未登入') {
            window.location.href = '/login';
          }
        } else {
          renderRecommendations(result.files, result.theme);
        }
      } catch (error) {
        console.error('fetchRecommendations error:', error);
        toastr.error('載入推薦文件失敗');
        window.location.href = '/login';
      }
    }

    // 上傳表單驗證
    document.getElementById('uploadForm').addEventListener('submit', (e) => {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        toastr.warning('請選擇一個文件進行上傳');
      }
    });

    // 搜尋輸入監聽
    document.getElementById('searchInput').addEventListener('input', (e) => {
      fetchFiles(e.target.value);
    });

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', () => {
      fetchUserInfo();
      fetchFiles();
      fetchRecommendations();
    });
  </script>
</body>
</html>